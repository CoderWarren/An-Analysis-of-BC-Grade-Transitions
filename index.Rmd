---
title: "An Analysis of BC Grade-to-Grade Transitions"
author: "Warren Zhu"
output: 
    html_document:
        toc: TRUE
        toc_float: TRUE
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
# Set up everything here. This is hidden from the final output
#install.packages(c("data.table","leaflet"))
library(readxl)
library(data.table)
library(leaflet)
library(tidyverse)
library(ggplot2)
library(mgcv)

library(plotly)
library(knitr)
library(widgetframe)
```

```{r read-in, echo=FALSE, message=FALSE, warning=FALSE}
# Read in the 1992 to 2001 data
data_1 <- read_excel("data_transitions/grtogrtransition_1992-93_to_2000-01.xlsx")
# Read in the 2001 to 2011 data
data_2 <- read_excel("data_transitions/grtogrtransition_2001-02_to_2010-11.xlsx")
# Read in the 2011 to 2021 data
data_3 <- read_excel("data_transitions/grtogrtransition_2011-12_to_2020-21.xlsx")
# Read in the locations
locations <- data.table::fread("data_districts/current_district_office_information.csv")
```

```{r data-prep-1, echo=FALSE, message=FALSE, warning=FALSE, results=FALSE}
# Here, we prepare the merged data set

# Combine all the data
data <- rbind(data_1, data_2, data_3)

# Remove all missing values
data <- data[!(data$DENOMINATOR_STUDIED_COHORT=="Msk"|
                 data$NUMERATOR_NUM_SUCCESSFUL=="Msk"|
               data$G2G_TRANSITION_RATE=="Msk"),]

# Make an integer variable storing the year
data$year <- strtoi(substr(data$SCHOOL_YEAR, 1, 4))

# Make the grade to grade transition rates a float
data$rate <- as.double(data$G2G_TRANSITION_RATE)

# Make the number of students an integer
data$num_students <- as.integer(data$DENOMINATOR_STUDIED_COHORT)

# Make the number of students who successfully moved on an integer
data$num_successful <- as.integer(data$NUMERATOR_NUM_SUCCESSFUL)

# Make the student grade a factor
data$grade <- as.factor(data$STUDENT_GRADE)

# Drop the unnecessary columns
data <- subset(data, select=-c(BASE_YEAR, SCHOOL_YEAR, G2G_TRANSITION_RATE,
                               MEASURE_NAME, DENOMINATOR_STUDIED_COHORT,
                               NUMERATOR_NUM_SUCCESSFUL, STUDENT_GRADE,
                               DISTRICT_NAME))
```

```{r data-prep-2, echo=FALSE, message=FALSE, warning=FALSE, results=FALSE}
data %>% 
  filter(DATA_LEVEL == "Province Level") %>%
  filter(PUBLIC_OR_INDEPENDENT == "Province - Total") %>%
  filter(FACILITY_TYPE == "All Facility Types") -> data_province
```

```{r data-prep-3, echo=FALSE, message=FALSE, warning=FALSE, results=FALSE}
# Drop all the rows in our table regarding data on a "Province Level"
# This is because we will not use it for the remainder of the assignment
data_district <- data[!(data$DATA_LEVEL=="Province Level"),]
data_district$district <- as.integer(data_district$DISTRICT_NUMBER)

# Now that we're on a district level, we can use the location data
data_district <- left_join(x=data_district, y=locations, 
                           by=c("district" = "DISTRICT_NUMBER"))

# Drop columns that aren't used
data_district <- subset(data_district, select=-c(
  DISTRICT_PROVINCE, DISTRICT_POSTAL_CODE, 
  DISTRICT_PHONE_NUMBER, DISTRICT_WEBSITE))

# Turn our district into a factor variable
data_district$district <- as.factor(data_district$district)

# Check what we have
summary(data_district)
```


## Introduction

This site was created with the intention of answering the following question: 

**How has the quality of education/opportunities in the past 30 years differed in different kinds of schools, as well as for different types of British Columbian students (i.e., indigenous? Special needs?)?**

Note that although this is just one question, it is a very complex one, and so naturally, a lot of data is required to answer it. Thus, this website uses [open data from British Columbia](https://catalogue.data.gov.bc.ca/)--specifically, [the 1992-2021 data on grade-to-grade transition published by British Columbia Education Analytics](https://catalogue.data.gov.bc.ca/dataset/bc-schools-grade-to-grade-transition). To gather information regarding the districts, this site also uses [information regarding each district's office, also published by the British Columbia Education Analytics](https://catalogue.data.gov.bc.ca/dataset/bc-schools-school-district-information). By using the grade-to-grade transitions as a metric for the quality of education/opportunities, we can formulate a nuanced response to the question.

If you wish to see the Github repository for this site, [you can find it here](https://github.com/CoderWarren/An-Analysis-of-BC-Grade-Transitions).

## Methods

```{r}
#WORK IN PROGRESS
```

## Results

```{r}
#WORK IN PROGRESS
```

### General Overview {.tabset}

#### Provincial Level

```{r plot-prep1, echo=FALSE, message=FALSE, warning=FALSE}
province_plot <- data_province %>%  # Code for the plot
  plot_ly(x = ~year, 
          y=~rate, 
          type="scatter", 
          mode="line",
          customdata = ~SUB_POPULATION,
          color=~grade, 
          colors="Set2",
          transforms=list(
            list(
              type = 'filter',
              target = 'customdata',
              operation = '=',
              value = unique(data_province$SUB_POPULATION)[1]
              )
            )
          ) %>% # The dropdown menu for SUBPOPULATION
  layout(
    title="Rate of successful grade transitions (1993-2020)",
    yaxis = list(title = "% of BC Students who Transitioned to the Next Grade"),
    xaxis=list(title="Year",
               categoryorder = "array",
              categoryarray = data_province$year),
    legend = list(title=list(text='<b> Student Grade Level </b>')),
    updatemenus = list(list(
      type = 'dropdown',
      active = 0,
      buttons=list(
        list(method = "restyle",
               args = list("transforms[0].value", unique(data_province$SUB_POPULATION)[1]),
               label = unique(data_province$SUB_POPULATION)[1]),
        list(method = "restyle",
               args = list("transforms[0].value", unique(data_province$SUB_POPULATION)[2]),
               label = unique(data_province$SUB_POPULATION)[2]),
        list(method = "restyle",
               args = list("transforms[0].value", unique(data_province$SUB_POPULATION)[3]),
               label = unique(data_province$SUB_POPULATION)[3]),
        list(method = "restyle",
               args = list("transforms[0].value", unique(data_province$SUB_POPULATION)[4]),
               label = unique(data_province$SUB_POPULATION)[4]),
        list(method = "restyle",
               args = list("transforms[0].value", unique(data_province$SUB_POPULATION)[5]),
               label = unique(data_province$SUB_POPULATION)[5])
      )
    )
  ))

# Had a lot of trouble creating this plot, but this link helped:
# https://stackoverflow.com/questions/52321695/filter-a-plotly-line-chart-based-on-categorical-variable
```

```{r plot1, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="A graph depicting the percentage of students in BC of each grade level that successfully transition to the next grade between the years 1993 and 2020."}
province_plot
```

#### District Level

```{r plot3, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="A graph depicting the percentage of high school BC students that successfully transition to the next grade between the years 1993 and 2020."}
data_district %>% 
  filter(DATA_LEVEL == "District Level") %>%
  filter(SUB_POPULATION == "All Students") %>%
  filter(FACILITY_TYPE == "All Facility Types") %>%
  filter(grade==8|grade==9|grade==10|grade==11) %>% #It's factored, can't use ">="
  ggplot(aes(x=year, y=rate, color=district)) +
  geom_line() +
  facet_wrap(~grade) +
  xlab("Year") +
  ylab("Percentage of Students who Transitioned to the Next Grade") +
  labs(title="Rate of grade transitions for BC Students (1993-2020)",
       color="School District") -> district_plot
ggplotly(district_plot)
```

#### School Level


## Conclusions and Summary

```{r}
#WORK IN PROGRESS
```
