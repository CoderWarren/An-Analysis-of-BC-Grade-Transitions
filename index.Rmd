---
title: "An Analysis of BC Grade-to-Grade Transitions"
author: "Warren Zhu"
output: 
    html_document:
        toc: TRUE
        toc_float: TRUE
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
# Set up everything here. This is hidden from the final output
#install.packages(c("data.table","leaflet"))
library(readxl)
library(data.table)
library(leaflet)
library(tidyverse)
library(ggplot2)
library(mgcv)

library(plotly)
library(knitr)
library(widgetframe)
```

```{r read-in, echo=FALSE, message=FALSE, warning=FALSE}
# Read in the 1992 to 2001 data
data_1 <- read_excel("data_transitions/grtogrtransition_1992-93_to_2000-01.xlsx")
# Read in the 2001 to 2011 data
data_2 <- read_excel("data_transitions/grtogrtransition_2001-02_to_2010-11.xlsx")
# Read in the 2011 to 2021 data
data_3 <- read_excel("data_transitions/grtogrtransition_2011-12_to_2020-21.xlsx")
# Read in the locations
locations <- data.table::fread("data_districts/current_district_office_information.csv")
```

```{r data-prep-1, echo=FALSE, message=FALSE, warning=FALSE, results=FALSE}
# Here, we prepare the merged data set

# Combine all the data
data <- rbind(data_1, data_2, data_3)

# Remove all missing values
data <- data[!(data$DENOMINATOR_STUDIED_COHORT=="Msk"|
                 data$NUMERATOR_NUM_SUCCESSFUL=="Msk"|
               data$G2G_TRANSITION_RATE=="Msk"),]

# Make an integer variable storing the year
data$year <- strtoi(substr(data$SCHOOL_YEAR, 1, 4))

# Make the grade to grade transition rates a float
data$rate <- as.double(data$G2G_TRANSITION_RATE)

# Make the number of students an integer
data$num_students <- as.integer(data$DENOMINATOR_STUDIED_COHORT)

# Make the number of students who successfully moved on an integer
data$num_successful <- as.integer(data$NUMERATOR_NUM_SUCCESSFUL)

# Make the student grade a factor
data$grade <- as.factor(data$STUDENT_GRADE)

# Drop the unnecessary columns
data <- subset(data, select=-c(BASE_YEAR, SCHOOL_YEAR, G2G_TRANSITION_RATE,
                               MEASURE_NAME, DENOMINATOR_STUDIED_COHORT,
                               NUMERATOR_NUM_SUCCESSFUL, STUDENT_GRADE,
                               DISTRICT_NAME))
```

```{r data-prep-2, echo=FALSE, message=FALSE, warning=FALSE, results=FALSE}
data %>% 
  filter(DATA_LEVEL == "Province Level") %>%
  filter(FACILITY_TYPE == "All Facility Types") -> data_province
```

```{r data-prep-3, echo=FALSE, message=FALSE, warning=FALSE, results=FALSE}
# Drop all the rows in our table regarding data on a "Province Level"
# This is because we will not use it for the remainder of the assignment
data_district <- data %>% filter(DATA_LEVEL == "District Level")
data_district$district <- as.integer(data_district$DISTRICT_NUMBER)

# Now that we're on a district level, we can use the location data
data_district <- left_join(x=data_district, y=locations, 
                           by=c("district" = "DISTRICT_NUMBER"))

# Drop columns that aren't used
data_district <- subset(data_district, select=-c(
  DISTRICT_PROVINCE, DISTRICT_POSTAL_CODE, 
  DISTRICT_PHONE_NUMBER, DISTRICT_WEBSITE))

# Turn our district into a factor variable
data_district$district <- as.factor(data_district$district)

# Check what we have
summary(data_district)
```

```{r data-prep-4, echo=FALSE, message=FALSE, warning=FALSE, results=FALSE}
data_school <- data %>% filter(DATA_LEVEL == "School Level")
data_school$district <- as.integer(data_school$DISTRICT_NUMBER)
data_school$year <- as.factor(data_school$year)
```


## Introduction

This site was created with the intention of answering the following question: 

**How has the quality of education/opportunities in the past 30 years differed in different kinds of schools, as well as for different types of British Columbian students (i.e., indigenous? Special needs?)?**

Note that although this is just one question, it is a very complex one, and so naturally, a lot of data is required to answer it. Thus, this website uses [open data from British Columbia](https://catalogue.data.gov.bc.ca/)--specifically, [the 1992-2021 data on grade-to-grade transition published by British Columbia Education Analytics](https://catalogue.data.gov.bc.ca/dataset/bc-schools-grade-to-grade-transition). To gather information regarding the districts, this site also uses [information regarding each district's office, also published by the British Columbia Education Analytics](https://catalogue.data.gov.bc.ca/dataset/bc-schools-school-district-information). By using the grade-to-grade transitions as a metric for the quality of education/opportunities, we can formulate a nuanced response to the question.

If you wish to see the Github repository for this site, [you can find it here](https://github.com/CoderWarren/An-Analysis-of-BC-Grade-Transitions).

## Methods

```{r}
#WORK IN PROGRESS
```

## Results

```{r}
#WORK IN PROGRESS
```

### General Overview {.tabset}

#### Provincial Level

```{r plot-prep1, echo=FALSE, message=FALSE, warning=FALSE}
province_plot <- data_province %>%  # Code for the plot
  plot_ly(x = ~year, 
          y=~rate, 
          type="scatter", 
          mode="line",
          customdata = ~SUB_POPULATION,
          ids = ~PUBLIC_OR_INDEPENDENT,
          color=~grade, 
          colors="Set2",
          hoverinfo = 'text',
          text = ~paste('</br> Year: ', year,
                        '</br> Grade: ', grade,
                      '</br> Rate: ', rate),
          transforms=list(
            list(
              type = 'filter',
              target = 'customdata',
              operation = '=',
              value = unique(data_province$SUB_POPULATION)[1]
              ),
            list(
              type = 'filter',
              target = 'ids',
              operation = '=',
              value = unique(data_province$PUBLIC_OR_INDEPENDENT)[1]
              )
            )
          ) %>% # The dropdown menu for SUBPOPULATION
  layout(
    title="Rate of successful grade transitions (1993-2020)",
    yaxis = list(title = "% of Students who Transitioned to the Next Grade",
                 range = c(40,100)),
    xaxis=list(title="Year",
               categoryorder = "array",
              categoryarray = data_province$year),
    legend = list(title=list(text='<b> Student Grade Level </b>')),
    updatemenus = list(
      list(
        x=1,
        y = 0.1,
        type = 'dropdown',
        direction="up",
        active = 0,
        buttons=list(
          list(method = "restyle",
               args = list("transforms[0].value", unique(data_province$SUB_POPULATION)[1]),
               label = unique(data_province$SUB_POPULATION)[1]),
          list(method = "restyle",
               args = list("transforms[0].value", unique(data_province$SUB_POPULATION)[2]),
               label = unique(data_province$SUB_POPULATION)[2]),
          list(method = "restyle",
               args = list("transforms[0].value", unique(data_province$SUB_POPULATION)[3]),
               label = unique(data_province$SUB_POPULATION)[3]),
          list(method = "restyle",
               args = list("transforms[0].value", unique(data_province$SUB_POPULATION)[4]),
               label = unique(data_province$SUB_POPULATION)[4]),
          list(method = "restyle",
               args = list("transforms[0].value", unique(data_province$SUB_POPULATION)[5]),
               label = unique(data_province$SUB_POPULATION)[5])
          )
        ),
      list(
        x=1,
        y = 0.2,
        type = 'dropdown',
        direction="up",
        active = 0,
        buttons=list(
          list(method = "restyle",
               args = list("transforms[1].value", unique(data_province$PUBLIC_OR_INDEPENDENT)[1]),
               label = unique(data_province$PUBLIC_OR_INDEPENDENT)[1]),
          list(method = "restyle",
               args = list("transforms[1].value", unique(data_province$PUBLIC_OR_INDEPENDENT)[2]),
               label = unique(data_province$PUBLIC_OR_INDEPENDENT)[2]),
          list(method = "restyle",
               args = list("transforms[1].value", unique(data_province$PUBLIC_OR_INDEPENDENT)[3]),
               label = unique(data_province$PUBLIC_OR_INDEPENDENT)[3])
          )
        )
  ))

# Had a lot of trouble creating this plot, but this link helped:
# https://stackoverflow.com/questions/52321695/filter-a-plotly-line-chart-based-on-categorical-variable
```

```{r plot1, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Figure 1: An interactive graph depicting the percentage of students in BC of each grade level that successfully transition to the next grade between the years 1993 and 2020."}
province_plot
```

#### District Level

```{r plot-prep2, echo=FALSE, message=FALSE, warning=FALSE}
district_plot_1 <- data_district %>%  # Code for the plot
  plot_ly(x = ~year, 
          y=~rate, 
          type="scatter", 
          mode="line",
          customdata = ~SUB_POPULATION,
          ids = ~grade,
          color=~district, 
          colors="Set2",
          hoverinfo = 'text',
          text = ~paste('</br> Year: ', year,
                        '</br> District: ', district,
                        '</br> Grade: ', grade,
                      '</br> Rate: ', rate),
          transforms=list(
            list(
              type = 'filter',
              target = 'customdata',
              operation = '=',
              value = unique(data_district$SUB_POPULATION)[1]
              ),
            list(
              type = 'filter',
              target = 'ids',
              operation = '=',
              value = unique(data_district$grade)[1]
              )
            )
          ) %>% # The dropdown menu for SUBPOPULATION
  layout(
    title="Rate of successful grade transitions (1993-2020)",
    yaxis = list(title = "% of Students who Transitioned to the Next Grade"),
    xaxis=list(title="Year",
               categoryorder = "array",
              categoryarray = data_province$year),
    legend = list(title=list(text='<b> District </b>')),
    updatemenus = list(
      list(
        x=1,
        y = 0.1,
        type = 'dropdown',
        direction="up",
        active = 0,
        buttons=list(
          list(method = "restyle",
               args = list("transforms[0].value", unique(data_district$SUB_POPULATION)[1]),
               label = unique(data_district$SUB_POPULATION)[1]),
          list(method = "restyle",
               args = list("transforms[0].value", unique(data_district$SUB_POPULATION)[2]),
               label = unique(data_district$SUB_POPULATION)[2]),
          list(method = "restyle",
               args = list("transforms[0].value", unique(data_district$SUB_POPULATION)[3]),
               label = unique(data_district$SUB_POPULATION)[3]),
          list(method = "restyle",
               args = list("transforms[0].value", unique(data_district$SUB_POPULATION)[4]),
               label = unique(data_district$SUB_POPULATION)[4]),
          list(method = "restyle",
               args = list("transforms[0].value", unique(data_district$SUB_POPULATION)[5]),
               label = unique(data_district$SUB_POPULATION)[5])
          )
        ),
      list(
        x=1,
        y = 0.2,
        type = 'dropdown',
        direction="up",
        active = 0,
        buttons=list(
          list(method = "restyle",
               args = list("transforms[1].value", unique(data_district$grade)[1]),
               label = unique(data_district$grade)[1]),
          list(method = "restyle",
               args = list("transforms[1].value", unique(data_district$grade)[2]),
               label = unique(data_district$grade)[2]),
          list(method = "restyle",
               args = list("transforms[1].value", unique(data_district$grade)[3]),
               label = unique(data_district$grade)[3]),
          list(method = "restyle",
               args = list("transforms[1].value", unique(data_district$grade)[4]),
               label = unique(data_district$grade)[4]),
          list(method = "restyle",
               args = list("transforms[1].value", unique(data_district$grade)[5]),
               label = unique(data_district$grade)[5]),
          list(method = "restyle",
               args = list("transforms[1].value", unique(data_district$grade)[6]),
               label = unique(data_district$grade)[6]),
          list(method = "restyle",
               args = list("transforms[1].value", unique(data_district$grade)[7]),
               label = unique(data_district$grade)[7]),
          list(method = "restyle",
               args = list("transforms[1].value", unique(data_district$grade)[8]),
               label = unique(data_district$grade)[8]),
          list(method = "restyle",
               args = list("transforms[1].value", unique(data_district$grade)[9]),
               label = unique(data_district$grade)[9]),
          list(method = "restyle",
               args = list("transforms[1].value", unique(data_district$grade)[10]),
               label = unique(data_district$grade)[10]),
          list(method = "restyle",
               args = list("transforms[1].value", unique(data_district$grade)[11]),
               label = unique(data_district$grade)[11])
          )
        )
  ))
```

```{r plot2, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Figure 2: An interactive graph depicting the percentage of high school BC students that successfully transition to the next grade between the years 1993 and 2020."}
district_plot_1
```

```{r plot-prep3, echo=FALSE, message=FALSE, warning=FALSE}
data_district$year <- as.factor(data_district$year)
district_plot_2 <- data_district %>%
  plot_ly(
    y=~rate,
    color=~year,
    type="box",
    customdata=~SUB_POPULATION,
    ids=~grade,
    transforms=list(
      list(
        type = 'filter',
        target = 'customdata',
        operation = '=',
        value = unique(data_district$SUB_POPULATION)[1]
        ),
      list(
        type = 'filter',
        target = 'ids',
        operation = '=',
        value = unique(data_district$grade)[1]
        )
      )
    ) %>% # The dropdown menu for SUBPOPULATION
  layout(
    title="Rate of successful grade transitions (1993-2020)",
    yaxis = list(title = "% of Students who Transitioned to the Next Grade"),
    xaxis=list(title="Year",
               categoryorder = "array",
              categoryarray = data_province$year),
    legend = list(title=list(text='<b> District </b>')),
    updatemenus = list(
      list(
        x=1,
        y = 0.1,
        type = 'dropdown',
        direction="up",
        active = 0,
        buttons=list(
          list(method = "restyle",
               args = list("transforms[0].value", unique(data_district$SUB_POPULATION)[1]),
               label = unique(data_district$SUB_POPULATION)[1]),
          list(method = "restyle",
               args = list("transforms[0].value", unique(data_district$SUB_POPULATION)[2]),
               label = unique(data_district$SUB_POPULATION)[2]),
          list(method = "restyle",
               args = list("transforms[0].value", unique(data_district$SUB_POPULATION)[3]),
               label = unique(data_district$SUB_POPULATION)[3]),
          list(method = "restyle",
               args = list("transforms[0].value", unique(data_district$SUB_POPULATION)[4]),
               label = unique(data_district$SUB_POPULATION)[4]),
          list(method = "restyle",
               args = list("transforms[0].value", unique(data_district$SUB_POPULATION)[5]),
               label = unique(data_district$SUB_POPULATION)[5])
          )
        ),
      list(
        x=1,
        y = 0.2,
        type = 'dropdown',
        direction="up",
        active = 0,
        buttons=list(
          list(method = "restyle",
               args = list("transforms[1].value", unique(data_district$grade)[1]),
               label = unique(data_district$grade)[1]),
          list(method = "restyle",
               args = list("transforms[1].value", unique(data_district$grade)[2]),
               label = unique(data_district$grade)[2]),
          list(method = "restyle",
               args = list("transforms[1].value", unique(data_district$grade)[3]),
               label = unique(data_district$grade)[3]),
          list(method = "restyle",
               args = list("transforms[1].value", unique(data_district$grade)[4]),
               label = unique(data_district$grade)[4]),
          list(method = "restyle",
               args = list("transforms[1].value", unique(data_district$grade)[5]),
               label = unique(data_district$grade)[5]),
          list(method = "restyle",
               args = list("transforms[1].value", unique(data_district$grade)[6]),
               label = unique(data_district$grade)[6]),
          list(method = "restyle",
               args = list("transforms[1].value", unique(data_district$grade)[7]),
               label = unique(data_district$grade)[7]),
          list(method = "restyle",
               args = list("transforms[1].value", unique(data_district$grade)[8]),
               label = unique(data_district$grade)[8]),
          list(method = "restyle",
               args = list("transforms[1].value", unique(data_district$grade)[9]),
               label = unique(data_district$grade)[9]),
          list(method = "restyle",
               args = list("transforms[1].value", unique(data_district$grade)[10]),
               label = unique(data_district$grade)[10]),
          list(method = "restyle",
               args = list("transforms[1].value", unique(data_district$grade)[11]),
               label = unique(data_district$grade)[11])
          )
        )
  ))
```

```{r plot3, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Figure 3: An interactive boxplot depicting the percentage of grade 10 BC students from each district that successfully transitioned to the next grade between the years 1993 and 2020."}
district_plot_2
```


#### School Level

```{r}
#WORK IN PROGRESS
```

## Conclusions and Summary

```{r}
#WORK IN PROGRESS
```
